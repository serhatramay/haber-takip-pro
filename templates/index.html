<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haber Takip Pro</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f0f2f5;color:#1a1a2e;min-height:100vh}
        .header{background:linear-gradient(135deg,#1a1a2e,#16213e);color:#fff;padding:18px 30px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100;box-shadow:0 2px 10px rgba(0,0,0,.2)}
        .header h1{font-size:22px;font-weight:700}.header h1 span{color:#e94560}
        .hdr-right{display:flex;align-items:center;gap:15px;font-size:13px;opacity:.85}
        .dot{width:8px;height:8px;border-radius:50%;background:#4ecca3;display:inline-block;animation:pulse 2s infinite}
        .dot.off{background:#e94560;animation:none}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
        .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;padding:18px 30px}
        .sc{background:#fff;border-radius:12px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
        .sc .lb{font-size:11px;color:#888;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
        .sc .vl{font-size:26px;font-weight:700}.sc .vl.red{color:#e94560}
        .main{display:grid;grid-template-columns:300px 1fr;gap:18px;padding:0 30px 30px}
        .sidebar{position:sticky;top:85px;align-self:start}
        .pnl{background:#fff;border-radius:12px;padding:18px;box-shadow:0 1px 3px rgba(0,0,0,.06);margin-bottom:12px}
        .pnl h3{font-size:14px;font-weight:600;margin-bottom:3px}.pnl .sub{font-size:11px;color:#888;margin-bottom:12px}
        .kw-inp{display:flex;gap:6px;margin-bottom:12px}
        .kw-inp input{flex:1;border:1.5px solid #e0e0e0;border-radius:8px;padding:9px 12px;font-size:13px;outline:0;transition:border .2s}
        .kw-inp input:focus{border-color:#4361ee}
        .kw-inp button{background:#4361ee;color:#fff;border:0;border-radius:8px;width:38px;cursor:pointer;font-size:18px;transition:background .2s}
        .kw-inp button:hover{background:#3a56d4}
        .kw-list{display:flex;flex-wrap:wrap;gap:6px;max-height:220px;overflow-y:auto}
        .kw-tag{display:flex;align-items:center;gap:5px;background:#f0f2f5;border-radius:18px;padding:5px 11px;font-size:12px;transition:all .2s}
        .kw-tag:hover{background:#e8e8ee}
        .kw-tag .cnt{background:#4361ee;color:#fff;border-radius:10px;padding:1px 6px;font-size:10px;font-weight:600}
        .kw-tag .rm{cursor:pointer;color:#999;font-size:15px;line-height:1}.kw-tag .rm:hover{color:#e94560}
        .scan-btn{width:100%;padding:12px;background:linear-gradient(135deg,#4361ee,#3a56d4);color:#fff;border:0;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;transition:all .3s;display:flex;align-items:center;justify-content:center;gap:8px}
        .scan-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(67,97,238,.3)}
        .scan-btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
        .scan-btn.scanning{background:linear-gradient(135deg,#e94560,#c73e54)}
        .auto-row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-top:1px solid #f0f0f0;margin-top:8px}
        .auto-row:first-child{border:0;margin:0}
        .auto-row label{font-size:12px;color:#555}
        .toggle{position:relative;width:40px;height:22px}
        .toggle input{display:none}
        .toggle .sl{position:absolute;inset:0;background:#ccc;border-radius:22px;cursor:pointer;transition:.3s}
        .toggle .sl:before{content:'';position:absolute;width:16px;height:16px;background:#fff;border-radius:50%;left:3px;top:3px;transition:.3s}
        .toggle input:checked+.sl{background:#4ecca3}
        .toggle input:checked+.sl:before{transform:translateX(18px)}
        .intv{border:1px solid #ddd;border-radius:6px;padding:3px 6px;font-size:11px;outline:0}
        .next-info{font-size:10px;color:#888;margin-top:6px}
        .feed-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
        .feed-hdr h2{font-size:17px;font-weight:600}
        .badge{background:#e94560;color:#fff;border-radius:10px;padding:2px 9px;font-size:11px;font-weight:600;margin-left:6px}
        .filters{display:flex;gap:6px}
        .fbtn{padding:5px 12px;border:1.5px solid #e0e0e0;background:#fff;border-radius:18px;font-size:11px;cursor:pointer;transition:all .2s}
        .fbtn.active{border-color:#4361ee;background:#4361ee;color:#fff}
        .fbtn:hover{border-color:#4361ee}
        .nc{background:#fff;border-radius:12px;padding:14px 18px;margin-bottom:8px;box-shadow:0 1px 3px rgba(0,0,0,.05);transition:all .2s;border-left:3px solid transparent;cursor:pointer}
        .nc:hover{box-shadow:0 3px 10px rgba(0,0,0,.1);border-left-color:#4361ee}
        .nc.new{border-left-color:#e94560;background:#fff8f8}
        .nc .tt{font-size:13px;font-weight:500;line-height:1.5;margin-bottom:6px;color:#1a1a2e}
        .nc .mt{display:flex;align-items:center;gap:8px;font-size:11px;color:#888;flex-wrap:wrap}
        .nc .mt .tg{background:#f0f2f5;padding:2px 8px;border-radius:10px;font-weight:500;color:#4361ee}
        .nc .mt .sr{font-weight:500;color:#555}
        .nc .mt .tm{margin-left:auto}
        .nc .acts{display:flex;gap:6px;margin-top:6px}
        .nc .acts button{background:0;border:1px solid #e0e0e0;border-radius:5px;padding:3px 8px;font-size:10px;cursor:pointer;transition:all .2s}
        .nc .acts button:hover{background:#f0f2f5}
        .nc .acts button.saved{background:#e94560;color:#fff;border-color:#e94560}
        .empty{text-align:center;padding:50px 20px;color:#aaa}.empty .ic{font-size:42px;margin-bottom:12px}.empty p{font-size:13px}
        .toast{position:fixed;bottom:20px;right:20px;background:#1a1a2e;color:#fff;padding:10px 18px;border-radius:10px;font-size:12px;display:none;z-index:200;box-shadow:0 4px 15px rgba(0,0,0,.2);animation:su .3s ease}
        .toast.ok{background:#4ecca3}.toast.err{background:#e94560}
        @keyframes su{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
        .lbar{position:fixed;top:0;left:0;height:3px;background:linear-gradient(90deg,#4361ee,#e94560);width:0;z-index:300;transition:width .3s}
        @media(max-width:768px){.main{grid-template-columns:1fr}.sidebar{position:static}.stats{grid-template-columns:repeat(2,1fr)}}
    </style>
</head>
<body>
<div class="lbar" id="lbar"></div>
<div class="header">
    <div><h1>Haber <span>Takip</span> Pro</h1></div>
    <div class="hdr-right">
        <span><span class="dot" id="dot"></span> <span id="stxt">Haz&#305;r</span></span>
        <span id="lstime">Son tarama: -</span>
    </div>
</div>
<div class="stats">
    <div class="sc"><div class="lb">Toplam Haber</div><div class="vl" id="s_total">0</div></div>
    <div class="sc"><div class="lb">Son Taramada</div><div class="vl red" id="s_new">0</div></div>
    <div class="sc"><div class="lb">Tarama Say&#305;s&#305;</div><div class="vl" id="s_scan">0</div></div>
    <div class="sc"><div class="lb">Kaydedilen</div><div class="vl" id="s_saved">0</div></div>
    <div class="sc"><div class="lb">Anahtar Kelime</div><div class="vl" id="s_kw">0</div></div>
</div>
<div class="main">
    <div class="sidebar">
        <div class="pnl">
            <h3>Anahtar Kelimeler</h3>
            <div class="sub">Takip etmek istedi&#287;in konular&#305; ekle</div>
            <div class="kw-inp">
                <input type="text" id="kwInp" placeholder="Yeni kelime...">
                <button id="kwAddBtn">+</button>
            </div>
            <div class="kw-list" id="kwList"></div>
        </div>
        <button class="scan-btn" id="scanBtn">Hemen Tara</button>
        <div class="pnl" style="margin-top:12px">
            <div class="auto-row" style="border:0;margin:0">
                <label>Otomatik Tarama</label>
                <label class="toggle"><input type="checkbox" id="autoTgl"><span class="sl"></span></label>
            </div>
            <div class="auto-row">
                <label>Aral&#305;k</label>
                <select class="intv" id="intv">
                    <option value="5">5 dk</option>
                    <option value="10" selected>10 dk</option>
                    <option value="15">15 dk</option>
                    <option value="30">30 dk</option>
                </select>
            </div>
            <div class="next-info" id="nextInfo"></div>
        </div>
    </div>
    <div>
        <div class="feed-hdr">
            <h2>Son Haberler <span class="badge" id="nbadge">0</span></h2>
            <div class="filters">
                <button class="fbtn active" data-filter="all">T&#252;m&#252;</button>
                <button class="fbtn" data-filter="new">Yeni</button>
                <button class="fbtn" data-filter="saved">Kaydedilen</button>
            </div>
        </div>
        <div id="nlist">
            <div class="empty"><div class="ic">&#128240;</div><p>Hen&#252;z haber yok. "Hemen Tara" butonuna bas.</p></div>
        </div>
    </div>
</div>
<div class="toast" id="toast"></div>

<script>
var filter = 'all';
var scanning = false;
var savedSet = {};
var pollTimer = null;

function api(path, opts) {
    opts = opts || {};
    return fetch('/api/' + path, opts).then(function(r) { return r.json(); });
}

function loadAll() {
    Promise.all([
        api('status'),
        api('news?filter=' + filter + '&limit=100'),
        api('keywords')
    ]).then(function(results) {
        var status = results[0];
        var news = results[1];
        var kws = results[2];
        document.getElementById('s_total').textContent = status.total_news;
        document.getElementById('s_new').textContent = status.new_count;
        document.getElementById('s_scan').textContent = status.scan_count;
        document.getElementById('s_saved').textContent = status.saved_count;
        document.getElementById('s_kw').textContent = status.keyword_count;
        document.getElementById('autoTgl').checked = status.auto_scan;
        document.getElementById('intv').value = status.interval_minutes;
        if (status.last_scan_time) {
            var d = new Date(status.last_scan_time);
            document.getElementById('lstime').textContent = 'Son tarama: ' + d.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
        }
        renderKws(kws.keywords);
        renderNews(news.news, news.total);
    }).catch(function(e) {
        console.error('loadAll error:', e);
    });
}

function renderKws(kws) {
    var el = document.getElementById('kwList');
    var html = '';
    for (var i = 0; i < kws.length; i++) {
        var k = kws[i];
        html += '<div class="kw-tag">' + esc(k.name);
        if (k.count) {
            html += '<span class="cnt">' + k.count + '</span>';
        }
        html += '<span class="rm" data-kw="' + esc(k.name) + '">&times;</span></div>';
    }
    el.innerHTML = html;
}

function renderNews(items, total) {
    document.getElementById('nbadge').textContent = total;
    var c = document.getElementById('nlist');
    if (!items || !items.length) {
        var msg = 'Hen\u00fcz haber yok.';
        if (filter === 'saved') msg = 'Kaydedilen haber yok.';
        if (filter === 'new') msg = 'Yeni haber yok.';
        c.innerHTML = '<div class="empty"><div class="ic">&#128240;</div><p>' + msg + '</p></div>';
        return;
    }
    var html = '';
    for (var i = 0; i < items.length; i++) {
        var n = items[i];
        html += '<div class="nc ' + (n.is_new ? 'new' : '') + '" data-url="' + esc(n.url) + '">';
        html += '<div class="tt">' + esc(n.title) + '</div>';
        html += '<div class="mt">';
        html += '<span class="tg">' + esc(n.keyword) + '</span>';
        html += '<span class="sr">' + esc(n.source) + '</span>';
        html += '<span class="tm">' + fmtDate(n.pub_date) + '</span>';
        html += '</div>';
        html += '<div class="acts">';
        html += '<button class="save-btn ' + (savedSet[n.id] ? 'saved' : '') + '" data-id="' + n.id + '">' + (savedSet[n.id] ? 'Kaydedildi' : 'Kaydet') + '</button>';
        html += '</div></div>';
    }
    c.innerHTML = html;
}

function doScan() {
    if (scanning) return;
    scanning = true;
    var btn = document.getElementById('scanBtn');
    btn.disabled = true;
    btn.classList.add('scanning');
    btn.textContent = 'Taran\u0131yor...';
    document.getElementById('lbar').style.width = '60%';
    document.getElementById('stxt').textContent = 'Taran\u0131yor...';
    api('scan', {method: 'POST'}).then(function(r) {
        document.getElementById('lbar').style.width = '100%';
        toast(r.new_count + ' yeni haber bulundu!', 'ok');
        loadAll();
    }).catch(function(e) {
        toast('Tarama hatas\u0131', 'err');
    }).finally(function() {
        setTimeout(function() { document.getElementById('lbar').style.width = '0'; }, 800);
        btn.disabled = false;
        btn.classList.remove('scanning');
        btn.textContent = 'Hemen Tara';
        document.getElementById('stxt').textContent = 'Haz\u0131r';
        scanning = false;
    });
}

function addKw() {
    var inp = document.getElementById('kwInp');
    var kw = inp.value.trim();
    if (!kw) return;
    api('keywords', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({keyword: kw})
    }).then(function(r) {
        if (r.error) { toast(r.error, 'err'); return; }
        inp.value = '';
        toast(kw + ' eklendi', 'ok');
        loadAll();
    });
}

function rmKw(kw) {
    api('keywords/' + encodeURIComponent(kw), {method: 'DELETE'}).then(function() {
        toast(kw + ' kald\u0131r\u0131ld\u0131');
        loadAll();
    });
}

function toggleSave(id) {
    api('save/' + id, {method: 'POST'}).then(function() {
        if (savedSet[id]) {
            delete savedSet[id];
            toast('Kald\u0131r\u0131ld\u0131');
        } else {
            savedSet[id] = true;
            toast('Kaydedildi', 'ok');
        }
        loadAll();
    });
}

function toggleAuto() {
    var on = document.getElementById('autoTgl').checked;
    api('settings', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({auto_scan: on})
    }).then(function() {
        toast(on ? 'Otomatik tarama a\u00e7\u0131ld\u0131' : 'Otomatik tarama kapat\u0131ld\u0131', 'ok');
        if (on) startPoll(); else stopPoll();
    });
}

function updateIntv() {
    var v = parseInt(document.getElementById('intv').value);
    api('settings', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({interval_minutes: v})
    }).then(function() {
        toast('Aral\u0131k ' + v + ' dakika olarak ayarland\u0131', 'ok');
    });
}

function setFilter(f, btn) {
    filter = f;
    var btns = document.querySelectorAll('.fbtn');
    for (var i = 0; i < btns.length; i++) btns[i].classList.remove('active');
    if (btn) btn.classList.add('active');
    loadAll();
}

function startPoll() { stopPoll(); pollTimer = setInterval(loadAll, 30000); }
function stopPoll() { if (pollTimer) { clearInterval(pollTimer); pollTimer = null; } }

function fmtDate(s) {
    if (!s) return '';
    var d = new Date(s);
    var now = new Date();
    var diff = (now - d) / 1000 / 60;
    if (diff < 60) return Math.round(diff) + ' dk \u00f6nce';
    if (diff < 1440) return Math.round(diff / 60) + ' saat \u00f6nce';
    return d.toLocaleDateString('tr-TR') + ' ' + d.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
}

function esc(t) {
    if (!t) return '';
    var d = document.createElement('div');
    d.textContent = t;
    return d.innerHTML;
}

function toast(m, t) {
    var e = document.getElementById('toast');
    e.textContent = m;
    e.className = 'toast ' + (t || '');
    e.style.display = 'block';
    setTimeout(function() { e.style.display = 'none'; }, 3000);
}

// Event listeners
document.getElementById('scanBtn').addEventListener('click', doScan);
document.getElementById('kwAddBtn').addEventListener('click', addKw);
document.getElementById('kwInp').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') addKw();
});
document.getElementById('autoTgl').addEventListener('change', toggleAuto);
document.getElementById('intv').addEventListener('change', updateIntv);

document.querySelector('.filters').addEventListener('click', function(e) {
    var btn = e.target;
    if (btn.dataset.filter) {
        setFilter(btn.dataset.filter, btn);
    }
});

document.getElementById('kwList').addEventListener('click', function(e) {
    if (e.target.classList.contains('rm')) {
        rmKw(e.target.dataset.kw);
    }
});

document.getElementById('nlist').addEventListener('click', function(e) {
    var card = e.target.closest('.nc');
    var saveBtn = e.target.closest('.save-btn');
    if (saveBtn) {
        e.stopPropagation();
        toggleSave(saveBtn.dataset.id);
    } else if (card && card.dataset.url) {
        window.open(card.dataset.url, '_blank');
    }
});

loadAll();
startPoll();
</script>
</body>
</html>

